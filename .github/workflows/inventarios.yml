name: Inventarios CI

on:
  push:
    branches: ["main"]
    paths:
      - "backend/**"
      - "figma-plugin/**"
      - ".github/workflows/inventarios.yml"
      - "backend/Dockerfile"
      - "package.json"
      - "package-lock.json"
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  packages: write
  security-events: write

concurrency:
  group: inventarios-${{ github.ref }}
  cancel-in-progress: true

jobs:
  inventarios:
    runs-on: ubuntu-latest
    env:
      PLUGIN_BASE: ${{ secrets.PLUGIN_BASE }}
      WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps (root, light)
        run: npm ci --ignore-scripts --no-audit --no-fund || true

      - name: Validar backend/.env y mostrar resumen seguro
        run: |
          echo "ðŸ” Validando backend/.env.example y backend/.env..."

          if [ ! -f backend/.env.example ]; then
            echo "âŒ Error: backend/.env.example no encontrado."
            exit 1
          fi

          if [ ! -f backend/.env ]; then
            echo "âŒ Error: backend/.env no fue generado correctamente."
            exit 1
          fi

          REQUIRED_VARS=(PORT DATABASE_URL PLUGIN_BASE WEBHOOK_SECRET)

          MISSING=false
          echo "ðŸ§ª Verificando variables obligatorias en backend/.env:"
          for VAR in "${REQUIRED_VARS[@]}"; do
            if grep -q "^$VAR=" backend/.env; then
              echo "âœ… $VAR estÃ¡ definido"
            else
              echo "âŒ $VAR falta en backend/.env"
              MISSING=true
            fi
          done

          if [ "$MISSING" = true ]; then
            echo "âŒ Faltan variables crÃ­ticas en backend/.env â†’ abortando"
            exit 1
          fi

          echo ""
          echo "ðŸ“‹ Resumen seguro del archivo backend/.env:"
          grep -E '^[A-Z0-9_]+=' backend/.env | cut -d= -f1 | while read VAR; do
            echo "â€¢ $VAR = ********"
          done

      - name: Lint workflows (actionlint)
        uses: rhysd/actionlint@v1

      - name: Start backend
        run: |
          if [ -f backend/src/server.js ]; then
            node backend/src/server.js &
            for i in {1..30}; do
              if curl -fsS http://127.0.0.1:4000/api/health >/dev/null 2>&1; then
                echo "Health local OK"
                break
              fi
              sleep 1
            done
          else
            echo "backend/src/server.js no existe, se omite arranque local."
          fi

      - name: Esperar backend antes de validar contrato
        run: |
          echo "âŒ› Esperando respuesta del backend (127.0.0.1:4000/api/health)..."
          for i in {1..60}; do
            if curl -fsS http://127.0.0.1:4000/api/health >/dev/null 2>&1; then
              echo "âœ… Backend respondiÃ³ correctamente"
              break
            fi
            if [ "$i" -eq 60 ]; then
              echo "âŒ Error: backend no respondiÃ³ despuÃ©s de 60s"
              exit 1
            fi
            sleep 1
          done

      - name: Validar contrato (opcional con plugin:start --no-up --no-e2e)
        env:
          CI: true
        run: |
          if [ -n "${PLUGIN_BASE:-}" ] && [ -n "${WEBHOOK_SECRET:-}" ]; then
            echo "Validando contrato contra ${PLUGIN_BASE} ..."
            npm run plugin:start -- --no-up --no-e2e
          else
            echo "PLUGIN_BASE/WEBHOOK_SECRET no definidos en Secrets -> se omite validacion remota."
          fi

  docker_backend:
    name: Docker Build & Push (backend multi-arch + OCI + SBOM)
    runs-on: ubuntu-latest
    needs: [inventarios]
    env:
      IMAGE: ghcr.io/carlosaraico/maizurbanofigmagithub-backend
      DOCKERFILE_PATH: ./backend/Dockerfile
      BUILD_CONTEXT: ./backend
    if: ${{ github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Derivar metadata (tags, version, created)
        id: meta
        shell: bash
        run: |
          SHORT="$(git rev-parse --short HEAD)"
          BRANCH="${GITHUB_REF_NAME:-}"
          SAN_BRANCH="$(echo "${BRANCH}" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9._-]/-/g')"
          PR=""
          if [ "${GITHUB_EVENT_NAME}" = "pull_request" ]; then
            PR="${{ github.event.pull_request.number }}"
          fi
          DATE_TAG="$(date -u +%Y%m%d)"
          CREATED="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          SOURCE="https://github.com/${GITHUB_REPOSITORY}"
          VERSION="$(node -e "try{console.log(require('./backend/package.json').version||'0.0.0')}catch{console.log('0.0.0')}" )"
          TAGS="${IMAGE}:sha-${SHORT}"
          TAGS="${TAGS}
${IMAGE}:date-${DATE_TAG}"
          if [ -n "${SAN_BRANCH}" ]; then
            TAGS="${TAGS}
${IMAGE}:branch-${SAN_BRANCH}"
          fi
          if [ -n "${PR}" ]; then
            TAGS="${TAGS}
${IMAGE}:pr-${PR}
${IMAGE}:pr-${PR}-sha-${SHORT}"
          fi
          if [ "${GITHUB_EVENT_NAME}" = "push" ] && [ "${BRANCH}" = "main" ]; then
            TAGS="${TAGS}
${IMAGE}:latest"
          fi

          echo "short=${SHORT}"        >> "$GITHUB_OUTPUT"
          echo "created=${CREATED}"    >> "$GITHUB_OUTPUT"
          echo "source=${SOURCE}"      >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}"    >> "$GITHUB_OUTPUT"
          echo "tags<<EOF"             >> "$GITHUB_OUTPUT"
          echo "${TAGS}"               >> "$GITHUB_OUTPUT"
          echo "EOF"                   >> "$GITHUB_OUTPUT"

      - name: Mostrar tags calculados
        run: |
          echo "TAGS:"
          echo "${{ steps.meta.outputs.tags }}"

      - name: Setup QEMU (multi-arch)
        uses: docker/setup-qemu-action@v3

      - name: Setup Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & Push (linux/amd64, linux/arm64) con labels OCI
        id: build
        uses: docker/build-push-action@v6
        with:
          context: ${{ env.BUILD_CONTEXT }}
          file: ${{ env.DOCKERFILE_PATH }}
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta.outputs.tags }}
          labels: |
            org.opencontainers.image.title=maizurbanofigmagithub-backend
            org.opencontainers.image.description=Maiz Urbano backend API
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ steps.meta.outputs.created }}
            org.opencontainers.image.version=${{ steps.meta.outputs.version }}
          cache-from: type=registry,ref=${{ env.IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.IMAGE }}:buildcache,mode=max
          provenance: false

      - name: Generar SBOM (Syft)
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.IMAGE }}@${{ steps.build.outputs.digest }}
          artifact-name: sbom-backend-spdx
          path: artifacts/sbom-backend.spdx.json
          format: spdx-json

      - name: Escanear vulnerabilidades (Grype) -> SARIF
        uses: anchore/scan-action@v3
        with:
          image: ${{ env.IMAGE }}@${{ steps.build.outputs.digest }}
          severity-cutoff: high
          fail-build: false
          output-format: sarif
          only-fixed: false

      - name: Subir SARIF a Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif

      - name: Subir SBOM como artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-backend-spdx
          path: artifacts/sbom-backend.spdx.json
          if-no-files-found: error
